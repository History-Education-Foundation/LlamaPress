<!-- Add these in the header section, after the existing script and style tags -->
<script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>

<% if current_user.tutorial_step == 0 %>
<script data-llama="exclude_when_saving_contenteditable_edits">
  var globalTutorialStep = '<%= current_user.tutorial_step %>'; //global variable to track the tutorial step
  globalTutorialStep = parseInt(globalTutorialStep);
  
  var doThisTour = true;

  if (globalTutorialStep == null || globalTutorialStep != 0) {
       doThisTour = false;
  }

  if (doThisTour){
    console.log("Loading llama tutorial! Step 1");
  }

  document.addEventListener('DOMContentLoaded', function() {
    const tour = new Shepherd.Tour({
      useModalOverlay: true,
      defaultStepOptions: {
        classes: 'shadow-md bg-purple-dark',
        scrollTo: true,
        cancelIcon: {
          enabled: true
        }
      }
    });

    tour.addStep({
      id: 'welcome',
      text: 'Welcome to LlamaPress! Let me show you around',
      buttons: [
        {
          text: 'Next',
          action: tour.next
        }
      ]
    });

    tour.addStep({
      id: 'chat-icon',
      attachTo: {
        element: '#chatIcon',
        on: 'bottom'
      },
      text: 'Click this icon anytime to open the chat window',
      buttons: [
        {
          text: 'Back',
          action: tour.back
        },
        {
          text: 'Next',
          action: () => { //wrapped in a closure so we need to call getIsOpen() function to get the value of calling isOpen directly. 
            if (!getIsOpen()){ // we don't want to toggle chat if it's already open
              toggleChat();
              document.getElementById('userInput').value = 'Redesign this page so its in nightmode';
            }
            tour.next();
          }
        }
      ]
    });

    tour.addStep({
      id: 'chat-input',
      attachTo: {
        element: '#userInput',
        on: 'top'
      },
      text: 'Type & send messages to change anything about the page',
      buttons: [
        {
          text: 'Back',
          action: tour.back
        },
        {
          text: 'Next',
          action: () => {
            //document.getElementById('userInput').value = 'Redesign this page so its in nightmode';

            document.getElementById('sendButton').addEventListener('click', () => {
              tour.next();
            }); //we need Next and Send button to do the same thing.

            tour.next();
          }
        }
      ]
    });

    
    tour.addStep({
      id: 'send-button',
      attachTo: {
        element: '#sendButton',
        on: 'bottom'
      },
      text: 'Send this message to change page to nightmode',
      buttons: [
        {
          text: 'Back',
          action: tour.back
        },
        {
          text: 'Next',
          action: tour.next
        }
      ]
    });

    tour.addStep({
      id: 'wait-for-thinking',
      text: 'Wait for LlamaBot to think... (this may take a while)',
      buttons: [
        {
          text: 'Back', //TODO: I want to force them to wait until thinking is completed, then I want to auto-refresh the page.
          action: tour.back
        },
        {
          text: 'Next',
          action: tour.next
        }
      ]
    });

    if (doThisTour) {
      setTimeout(() => {
        tour.start();
        tourStarted = true;
      }, 500);
    }

    // Move tutorial step forward when the tour is completed.
    tour.on('complete', () => {
      //TODO: do a PUT to /users/set_tutorial_step with tutorial_step = 1 (increment to next step in the tutorial)
      fetch('/users/set_tutorial_step', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          // Include CSRF token if your Rails app requires it
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]')?.content
        },
        body: JSON.stringify({ tutorial_step: 1 })
      });
    });
  });
</script>
<% end %>